<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>theclassics.school – How to Use This Site</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="https://unpkg.com/micromodal/dist/micromodal.min.css"/>
  <style>
    :root{--color-yellow:#FBAB34;--color-red:#E04E19;--color-orange:#E98839;--color-white:#FCEFDC;--color-green:#829559;--color-beige:#D8C19C;--font-base:"Crimson Pro",Georgia,"Times New Roman",serif;--font-classic:"Crimson Pro",Georgia,"Times New Roman",serif;--sticky-offset:120px;font-size:18px}
    *{margin:0;padding:0;box-sizing:border-box;caret-color:transparent}
    input,textarea,select{caret-color:auto}
    html,body{width:100%;height:100%}
    body{background-color:var(--color-white);font-family:var(--font-base);color:#333;line-height:1.6;font-size:1rem}
    p{margin-bottom:10px}
    h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:0.75rem;line-height:1.3}
    h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem}h4{font-size:1.25rem}
    header{background-color:var(--color-beige);padding:1rem;text-align:center;position:sticky;top:0;z-index:1000}
    header h1{color:var(--color-red);margin-bottom:0.5rem;line-height:1.2}
    header p{color:var(--color-green);font-size:1.125rem;line-height:1.4}
    nav{background-color:var(--color-orange);display:flex;justify-content:center;padding:0.5rem;position:sticky;top:60px;z-index:999;gap:1rem;flex-wrap:wrap}
    nav a{color:var(--color-white);text-decoration:none;margin:0;font-weight:bold;font-size:1rem;cursor:pointer;padding:0.35rem 0.75rem;border-radius:6px;transition:background-color .2s ease-in-out,color .2s ease-in-out}
    nav a.active{background-color:var(--color-red);color:#fff}
    .hero{background-color:var(--color-yellow);color:#fff;text-align:center;padding:2rem 1rem}
    .hero h2{margin-bottom:1rem}
    .hero p{max-width:600px;margin:0 auto;font-size:1.125rem;line-height:1.5}
    main{width:100%;margin:2rem 0;padding:0 1rem}
    .page-section{margin:2rem auto;max-width:1200px}
    .section-hidden{display:none!important}
    .course-search{text-align:center;margin-bottom:2rem}
    .course-search input[type=text]{width:60%;max-width:400px;padding:0.5rem;border:2px solid var(--color-green);border-radius:4px;font-size:1rem;line-height:1.5}
    .course-list{display:grid;grid-template-columns:1fr;gap:1rem}
    .course-card{background-color:var(--color-beige);border-radius:5px;padding:1rem;line-height:1.6}
    .course-card h3{color:var(--color-red);font-family:var(--font-classic);margin-bottom:0.5rem;font-size:1.25rem;line-height:1.3}
    .course-card p{margin-bottom:0.5rem;color:#555;font-size:1rem;line-height:1.5}
    .course-card button{background-color:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold;font-size:1rem;line-height:1.5}
    .course-card button:hover{background-color:#6e7a4b}
    .course-status{font-size:0.875rem;margin-top:0.5rem;font-style:italic}
    .course-status.not-started{color:#999}.course-status.in-progress{color:var(--color-orange)}.course-status.complete{color:var(--color-green)}.course-status.n-a{color:#ccc}
    .lessons-container{display:none;margin-top:2rem;border-top:1px solid #ccc;padding-top:1rem;transition:all .5s ease-in-out}
    .lesson-layout{display:grid;grid-template-columns:250px 1fr;gap:1rem;margin-top:1rem;transition:grid-template-columns .5s ease-in-out}
    .lesson-layout.collapsed{grid-template-columns:48px 1fr}
    .lesson-sidebar{background-color:var(--color-beige);border-radius:5px;transition:width .5s ease-in-out,padding .5s ease-in-out;position:relative;margin-left:5px;overflow-x:hidden}
    .lesson-sidebar.collapsed{width:50px;text-align:center;overflow-x:hidden}
    .sidebar-header{display:flex;align-items:center;padding:0.5rem 0;position:sticky;top:0;z-index:10;background-color:var(--color-beige);padding-top:20px}
    .sidebar-header-icon{color:var(--color-red);font-size:1.5rem;cursor:pointer;margin-right:0.5rem;transition:margin .3s ease-in-out;align-self:center;line-height:1;margin-left:10px}
    .lesson-sidebar.collapsed .sidebar-header-icon{margin-right:0}
    .title-text{transition:opacity .5s ease-in-out;opacity:1;visibility:visible}
    .lesson-sidebar.collapsed .title-text{display:none}
    .lesson-sidebar.collapsed .hover-checkbox{display:none!important}
    .lesson-list-wrapper{overflow-y:auto;padding-top:0.5rem}
    .lesson-sidebar.collapsed .lesson-list-wrapper{padding:0}
    #lessonProgress{margin-bottom:1rem;font-weight:bold}
    .lesson-list{list-style-type:none;margin:0;padding:0}
    .lesson-list li{display:grid;grid-template-columns:24px 1fr auto;align-items:center;padding:0.5rem 0.75rem;margin-bottom:0.25rem;border-radius:5px;transition:background-color .2s ease-in-out;position:relative;cursor:pointer;background-color:var(--color-beige)}
    .lesson-list li:not(:hover){grid-template-columns:24px 1fr}
    .lesson-list li:hover{background-color:#f5f0e6}
    .lesson-list li.completed{background-color:#d9efd0}
    .lesson-list li.active{background-color:#ffeec2;border-left:4px solid var(--color-green)}
    .hover-checkbox{display:none}
    .lesson-list li:hover .hover-checkbox{display:inline-block}
    .icon-area{text-align:center}
    .lesson-title{font-weight:bold;font-size:1rem;white-space:normal;line-height:1.4;overflow-wrap:break-word;margin:0 0.5rem}
    .lesson-sidebar.collapsed .lesson-title{display:none}
    .lesson-sidebar.collapsed li{justify-content:center}
    .lesson-content{border:1px solid #ccc;border-radius:5px;padding:1rem;min-height:300px;line-height:1.6;max-width:60ch}
    .lesson-content ul,.lesson-content li{margin-left:1.5rem;margin-bottom:0.5rem}
    .lesson-content h4{margin:1rem 0 0.5rem}
    footer{background-color:var(--color-green);color:var(--color-white);text-align:center;padding:1rem;margin-top:2rem;line-height:1.5}
    footer a{color:var(--color-white);text-decoration:underline}
    hr{margin-top:20px;margin-bottom:20px}
    .lesson-list li:focus,.sidebar-header-icon:focus,nav a:focus,button:focus{outline:none}
    @media(max-width:768px){.course-list{grid-template-columns:1fr 1fr}}
    .auth-section{text-align:center;margin-top:1rem;margin-bottom:2rem}
    #emailForSignIn{padding:0.5rem;border:2px solid var(--color-green);border-radius:4px;font-family:var(--font-base);width:280px;margin-bottom:0.5rem}
    #sendSignInLink{background-color:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold;font-size:1rem;line-height:1.5;margin:0.5rem}
    #sendSignInLink:hover{background-color:#6e7a4b}
    #lockedContent{display:none}
    .account-actions{display:flex;gap:0.5rem;justify-content:center;margin-bottom:1rem;flex-wrap:wrap}
    .account-actions button{background-color:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold;line-height:1.5}
    .account-actions button.secondary{background-color:var(--color-orange)}
    .settings-field{display:flex;flex-direction:column;gap:0.4rem;margin-bottom:0.75rem}
    .settings-field label{font-weight:bold}
    .settings-field input,.settings-field textarea{width:100%;padding:0.5rem;border:2px solid var(--color-green);border-radius:4px;font-family:var(--font-base)}
    .settings-warning{color:var(--color-red);font-weight:bold;margin:0.25rem 0}
    .settings-note{font-size:0.95rem;color:#5a4a34;margin-bottom:0.5rem}
    .settings-status{font-size:0.95rem;margin-bottom:0.5rem;min-height:1.2em}
    .settings-status.info{color:#5a4a34}
    .settings-status.success{color:var(--color-green)}
    .settings-status.error{color:var(--color-red)}
    .vault-card{background:var(--color-beige);border:1px solid #c9b28d;border-radius:6px;padding:1rem;margin:1rem auto;max-width:960px;line-height:1.5}
    .vault-card h3{color:var(--color-red);margin-bottom:0.5rem}
    .vault-card .helper-text{color:#5a4a34;margin-bottom:0.75rem}
    .vault-field{display:flex;flex-direction:column;gap:0.5rem;margin-bottom:0.75rem}
    .vault-field label{font-weight:bold}
    .vault-field input,.vault-field textarea{width:100%;padding:0.5rem;border:2px solid var(--color-green);border-radius:4px;font-family:var(--font-base)}
    .vault-actions{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem}
    .vault-actions button{background-color:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold;line-height:1.5}
    .vault-actions button.secondary{background-color:var(--color-orange)}
    .passphrase-warning{color:var(--color-red);font-weight:bold;margin-top:0.25rem}
    .copy-hint{color:#5a4a34;font-size:0.95rem;margin-top:0.25rem}
    .vault-note{color:#555;font-size:0.95rem;margin-top:0.35rem}
    .notes-list{display:grid;gap:0.75rem;margin-top:1rem}
    .notes-card{padding:0.85rem;border:1px solid #c9b28d;border-radius:6px;background:#fffaf2}
    .notes-card h4{margin-bottom:0.35rem;color:var(--color-red)}
    .notes-card p{margin:0.25rem 0}
    .modal__container.settings-modal{max-height:calc(100vh - var(--sticky-offset) - 2.5rem);overflow-y:auto;width:min(900px,95vw);padding:1.5rem}
    @media(max-width:640px){
      .modal__container.settings-modal{max-height:calc(100vh - var(--sticky-offset) - 1.5rem);width:95vw;padding:1.25rem}
      .modal__content{overflow-y:visible}
      .modal__overlay{padding:1.25rem 0.75rem;padding-top:calc(var(--sticky-offset) + 1.25rem)}
    }
    .passphrase-gate{position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:2000;padding:1rem}
    .passphrase-card{background:var(--color-white);border-radius:10px;max-width:520px;width:100%;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,0.15);border:2px solid var(--color-orange)}
    .passphrase-card h3{color:var(--color-red);margin-bottom:0.5rem}
    .passphrase-card .helper-text{color:#5a4a34;margin-bottom:0.75rem}
    .passphrase-actions{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:flex-end;margin-top:0.5rem}
    .passphrase-actions button{background:var(--color-green);color:#fff;border:none;padding:0.5rem 0.9rem;border-radius:6px;font-weight:bold;cursor:pointer}
    .lesson-notes{margin-top:1.5rem;padding:1rem;border:1px solid #c9b28d;border-radius:6px;background:#fffaf2}
    .lesson-notes h3{margin-bottom:0.5rem;color:var(--color-red)}
    .lesson-notes textarea{width:100%;border:2px solid var(--color-green);border-radius:6px;padding:0.6rem;font-family:var(--font-base);min-height:120px}
    .lesson-notes .note-actions{display:flex;justify-content:flex-end;margin-top:0.5rem}
    .lesson-notes .note-actions button{background:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;font-weight:bold;cursor:pointer}
    .locked{opacity:.4;pointer-events:none;position:relative}
    .modal{display:none}.modal.is-open{display:block}
    .modal__overlay{background:rgba(0,0,0,.5);position:fixed;inset:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:1.5rem 1rem;padding-top:calc(var(--sticky-offset) + 1.5rem);overflow-y:auto;scrollbar-width:thin}
    .modal__container{background:#fff;padding:1rem;border-radius:4px;width:90%;max-width:500px;margin:auto 0}
    .modal__header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .modal__title{font-size:1.25rem;margin:0}
    .modal__close{background:none;border:none;cursor:pointer;font-size:1.25rem}
    .modal__footer{text-align:right;margin-top:1rem}
    .modal__btn{background:var(--color-green);color:#fff;border:none;padding:0.5rem 1rem;cursor:pointer;border-radius:4px}
    table{width:100%;border-collapse:collapse;margin:1rem 0;overflow-x:auto;display:block}
    th,td{padding:0.75rem;border:1px solid #ddd;text-align:left}
    thead{background-color:var(--color-orange);color:var(--color-white)}
    tbody tr:nth-child(even){background-color:#f5f0e6}
  </style>
</head>
<body>
  <header>
    <h1>theclassics.school</h1>
    <p>A Place to Read, Discover, and Grow</p>
  </header>
  <nav>
    <a href="#" id="homeLink" class="active">Home</a>
    <a href="#" id="lessonsLink">Lessons</a>
    <a href="#" id="quizzesLink">Quizzes</a>
    <a href="#" id="notesLink">Notes</a>
  </nav>
  <section class="hero" data-section="home">
    <h2>Welcome to theclassics.school</h2>
    <p>Here you’ll find structured lessons inspired by timeless works of literature, philosophy, and beyond.</p>
  </section>
  <div id="passphraseGate" class="passphrase-gate" aria-live="polite">
    <div class="passphrase-card">
      <h3>Unlock your account</h3>
      <p class="helper-text">Enter your master passphrase to access lessons, settings, and notes. We only keep the key while this page is open.</p>
      <div class="vault-field">
        <label for="gatePassphrase">Master passphrase</label>
        <input id="gatePassphrase" type="password" autocomplete="current-password" placeholder="Enter your master passphrase"/>
        <p class="passphrase-warning">If you never set one, choose a strong passphrase below to initialize your encrypted vault.</p>
        <label style="display:flex;align-items:center;gap:0.5rem;margin-top:0.35rem;user-select:none;">
          <input id="gateTrustedDevice" type="checkbox"/>
          <span>Trusted computer (don’t ask again)</span>
        </label>
        <div class="passphrase-actions">
          <button id="gateUnlockBtn">Unlock</button>
          <button id="gateInitializeBtn" class="secondary">Set up new passphrase</button>
          <button id="gateGenerateBtn" class="secondary">Generate</button>
        </div>
      </div>
    </div>
  </div>
  <main>
    <div class="auth-section">
      <div><input id="emailForSignIn" type="email" placeholder="Enter your email"/></div>
      <button id="sendSignInLink">Send Sign-In Link</button>
      <p id="loginStatus" style="margin-top:0.5rem;color:var(--color-orange);"></p>
      <div id="signedInActions" class="account-actions" style="display:none;">
        <button id="openSettingsBtn">Settings</button>
        <button id="signOutBtn" class="secondary">Sign Out</button>
      </div>
    </div>
      <div id="lockedContent">
        <section id="vaultContainer" class="vault-card" style="display:none;">
          <h3 id="vaultHeading">Secure your account</h3>
          <p id="vaultDescription" class="helper-text">Enter or set a master passphrase to unlock lessons, settings, and notes. We cannot recover it if lost.</p>
          <div class="vault-field">
            <label for="vaultPassphrase">Master passphrase</label>
            <input id="vaultPassphrase" type="password" autocomplete="new-password" placeholder="Enter or paste your master passphrase"/>
            <p class="passphrase-warning">Keep this somewhere safe before you continue. Losing it means losing access to your encrypted data.</p>
            <div class="vault-actions">
              <button id="generatePassphraseBtn">Generate strong passphrase</button>
              <button id="copyPassphraseBtn" class="secondary">Copy passphrase</button>
            </div>
            <p class="copy-hint">Stored only in this session. We never send the passphrase to the server.</p>
          </div>
          <div class="vault-actions">
            <button id="initializeVaultBtn">Save &amp; initialize vault</button>
            <button id="unlockVaultBtn" class="secondary">Unlock existing vault</button>
          </div>
        </section>
        <section id="homeSection" class="page-section" data-section="home">
          <div class="course-search"><input type="text" id="courseSearch" placeholder="Search for a course..."></div>
          <div class="course-list" id="courseList"></div>
        </section>
      <section id="lessonsSection" class="page-section section-hidden" data-section="lessons">
        <div id="lessonsContainer" class="lessons-container">
          <h2 id="selectedCourseTitle" style="color:var(--color-red);font-family:var(--font-classic);"></h2>
          <p id="selectedCourseDesc"></p>
          <h4 id="lessonProgress"></h4>
          <div class="lesson-layout" id="lessonLayout">
            <aside class="lesson-sidebar" id="lessonSidebar">
              <div class="sidebar-header">
                <i class="fa-solid fa-feather sidebar-header-icon" id="sidebarToggle" title="Toggle Lessons Menu"></i>
                <h3 class="title-text">Lessons</h3>
              </div>
              <div class="lesson-list-wrapper"><ul id="lessonList" class="lesson-list"></ul></div>
            </aside>
            <div id="lessonContent" class="lesson-content"><p style="color:#999;">Select a lesson on the left to see details here.</p></div>
          </div>
        </div>
      </section>
      <section id="quizzesSection" class="page-section section-hidden" data-section="quizzes">
        <div class="vault-card">
          <h3>Quizzes</h3>
          <p class="helper-text">Generate quizzes for the lesson you’re currently studying. Unlock with your passphrase first.</p>
          <p id="quizLessonContext" class="settings-note"></p>
          <div class="vault-actions">
            <button id="generateQuizBtn">Generate Quiz</button>
          </div>
          <p id="quizStatus" class="settings-status info" role="status"></p>
        </div>
      </section>
      <section id="notesSection" class="page-section section-hidden" data-section="notes">
        <div class="vault-card">
          <h3>Notes</h3>
          <p class="helper-text">Your lesson notes are encrypted with your master passphrase. Unlock to read or update them.</p>
          <div id="notesList" class="notes-list"></div>
          <p id="notesEmptyState" class="settings-note"></p>
        </div>
      </section>
      </div>
    </div>
  </main>
  <footer>
    <p>© 2025 theclassics.school</p>
    <p>For inquiries, email <a href="mailto:info@theclassics.school" style="color:#fff;text-decoration:underline;">info@theclassics.school</a></p>
  </footer>
  <div class="modal micromodal-slide" id="modal-locked" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true">
        <header class="modal__header"><h2 class="modal__title">Lesson Locked</h2><button class="modal__close" data-micromodal-close></button></header>
        <main class="modal__content"><p>Please sign in to access this lesson.</p></main>
        <footer class="modal__footer"><button class="modal__btn" data-micromodal-close>Close</button></footer>
      </div>
    </div>
  </div>
  <div class="modal micromodal-slide" id="modal-settings" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container settings-modal" role="dialog" aria-modal="true">
        <header class="modal__header"><h2 class="modal__title">Account Settings</h2><button class="modal__close" data-micromodal-close></button></header>
        <main class="modal__content">
          <p class="settings-warning">Never lose your master passphrase. Without it, your encrypted data—including these settings—cannot be recovered.</p>
          <div id="settingsStatus" class="settings-status info" role="status" aria-live="polite"></div>
          <div id="settingsFields" style="display:none;">
            <div class="settings-field">
              <label for="settingsDisplayName">Display name</label>
              <input id="settingsDisplayName" type="text" placeholder="How you want to appear in the app"/>
            </div>
            <div class="settings-field">
              <label for="settingsApiKey">OpenAI API key</label>
              <input id="settingsApiKey" type="password" placeholder="Paste your OpenAI API key" autocomplete="off"/>
              <div class="settings-note">Stored only in your encrypted profile for lesson tools. Keep it private.</div>
            </div>
            <div class="settings-field">
              <label for="settingsMetadata">Account notes</label>
              <textarea id="settingsMetadata" rows="3" placeholder="Optional context about your account"></textarea>
            </div>
            <div class="settings-warning">Saving updates the encrypted profile in Firestore. Losing your passphrase will make this data inaccessible.</div>
          </div>
          <div class="settings-field">
            <label for="settingsNewPassphrase">Rotate passphrase (optional)</label>
            <input id="settingsNewPassphrase" type="password" autocomplete="new-password" placeholder="Enter a new master passphrase"/>
            <div class="settings-note">Rotating creates a new encryption key. You must remember the new passphrase to keep access.</div>
          </div>
        </main>
        <footer class="modal__footer" style="display:flex;flex-direction:column;gap:0.5rem;align-items:flex-end;">
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:flex-end;width:100%;">
            <button class="modal__btn" id="saveSettingsBtn" type="button">Save Settings</button>
            <button class="modal__btn" id="rotatePassphraseBtn" type="button" style="background:var(--color-orange);">Rotate Passphrase</button>
          </div>
          <button class="modal__btn" id="resetAccountBtn" type="button" style="background:var(--color-red);width:100%;">Reset encrypted data (irreversible)</button>
        </footer>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"
      import { getAuth, isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js"
      import { getFirestore, doc, getDoc, setDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js"
      import { decodeSalt, decryptSecret, deriveKeyFromPassphrase, encryptSecret, generatePassphrase } from "./vault.js"

    const firebaseConfig={apiKey:"AIzaSyAOFHZbn02JpIlSHNxNdvBnfdYv08tZMJs",authDomain:"the-classics-befd2.firebaseapp.com",projectId:"the-classics-befd2",storageBucket:"the-classics-befd2.firebasestorage.app",messagingSenderId:"171500319429",appId:"1:171500319429:web:2f67b006048191fa6036ac",measurementId:"G-08W3C50VF6"}
    const app=initializeApp(firebaseConfig)
    const auth=getAuth(app)
    const db=getFirestore(app)
    const actionCodeSettings={url:"https://theclassics.school",handleCodeInApp:true}

      const emailField=document.getElementById("emailForSignIn")
      const sendLinkBtn=document.getElementById("sendSignInLink")
      const loginStatus=document.getElementById("loginStatus")
      const lockedContent=document.getElementById("lockedContent")
      const signedInActions=document.getElementById("signedInActions")
      const vaultContainer=document.getElementById("vaultContainer")
      const vaultHeading=document.getElementById("vaultHeading")
      const vaultDescription=document.getElementById("vaultDescription")
      const vaultPassphraseInput=document.getElementById("vaultPassphrase")
      const gate=document.getElementById("passphraseGate")
      const gatePassphraseInput=document.getElementById("gatePassphrase")
      const gateUnlockBtn=document.getElementById("gateUnlockBtn")
      const gateInitializeBtn=document.getElementById("gateInitializeBtn")
      const gateGenerateBtn=document.getElementById("gateGenerateBtn")
      const gateTrustedDevice=document.getElementById("gateTrustedDevice")
      const initializeVaultBtn=document.getElementById("initializeVaultBtn")
      const unlockVaultBtn=document.getElementById("unlockVaultBtn")
      const generatePassphraseBtn=document.getElementById("generatePassphraseBtn")
      const copyPassphraseBtn=document.getElementById("copyPassphraseBtn")
      const openSettingsBtn=document.getElementById("openSettingsBtn")
      const signOutBtn=document.getElementById("signOutBtn")
      const settingsFields=document.getElementById("settingsFields")
      const settingsDisplayName=document.getElementById("settingsDisplayName")
      const settingsApiKey=document.getElementById("settingsApiKey")
      const settingsMetadata=document.getElementById("settingsMetadata")
      const settingsNewPassphrase=document.getElementById("settingsNewPassphrase")
      const saveSettingsBtn=document.getElementById("saveSettingsBtn")
      const rotatePassphraseBtn=document.getElementById("rotatePassphraseBtn")
      const resetAccountBtn=document.getElementById("resetAccountBtn")
      const settingsStatus=document.getElementById("settingsStatus")
      const generateQuizBtn=document.getElementById("generateQuizBtn")
      const quizLessonContext=document.getElementById("quizLessonContext")
      const quizStatus=document.getElementById("quizStatus")
      const notesList=document.getElementById("notesList")
      const notesEmptyState=document.getElementById("notesEmptyState")
      const navLinks={home:document.getElementById("homeLink"),lessons:document.getElementById("lessonsLink"),quizzes:document.getElementById("quizzesLink"),notes:document.getElementById("notesLink")}
      const sectionRegistry={home:document.querySelectorAll('[data-section="home"]'),lessons:document.querySelectorAll('[data-section="lessons"]'),quizzes:document.querySelectorAll('[data-section="quizzes"]'),notes:document.querySelectorAll('[data-section="notes"]')}
      let lessonProgress={lessons:{},notes:{}}
      const DATA_MIGRATION_VERSION=1
      let profileVersionInfo=buildVersionInfo("bootstrap-profile")
      let progressVersionInfo=buildVersionInfo("bootstrap-progress")
      let vaultDoc=null
      let derivedVaultKey=null
      let derivedVaultSalt=null
      let encryptedLessonProgressPayload=null
      let pendingEncryptedProgressPayload=null
      let decryptedUserPayload=null
      const TRUSTED_WRAP_DB="vault-wrap-store"
      const TRUSTED_WRAP_STORE="device-keys"
      const TRUSTED_WRAP_KEY_ID="wrapping-key"
      const TRUSTED_CACHE_ID="vault-cache"

    sendLinkBtn.onclick=async()=>{if(auth.currentUser){await signOut(auth);return}const email=emailField.value;if(!email){alert("Please enter your email.");return}try{await sendSignInLinkToEmail(auth,email,actionCodeSettings);localStorage.setItem("emailForSignIn",email);alert("Sign-in link sent! Check your email.")}catch(e){console.error(e);alert("Error sending link.")}}

    if(isSignInWithEmailLink(auth,window.location.href)){
      let storedEmail=localStorage.getItem("emailForSignIn")
      if(!storedEmail){
        storedEmail=window.prompt("Confirm your email to finish signing in")
      }
      if(storedEmail){
        signInWithEmailLink(auth,storedEmail,window.location.href)
          .then(()=>{localStorage.removeItem("emailForSignIn");alert("You are now signed in!");window.history.replaceState({},document.title,"/")})
          .catch(e=>{console.error(e);alert("Could not complete sign-in. Please try the link again.")})
      }
    }

      onAuthStateChanged(auth,async user=>{if(user){loginStatus.textContent=`Signed in as: ${user.email}`;sendLinkBtn.textContent="Send Sign-In Link";emailField.style.display="none";lockedContent.style.display="block";signedInActions.style.display="flex"}else{loginStatus.textContent="Not signed in";sendLinkBtn.textContent="Send Sign-In Link";emailField.style.display="inline-block";emailField.value="";lockedContent.style.display="none";signedInActions.style.display="none";clearVaultState();currentCourseData={};currentCoursePath="";currentLessonSelection=null;setActiveSection("home");updateQuizContext();setQuizStatus("");renderNotesSummary()}
        await loadUserProgress(user)
        await loadVaultState(user)
        await tryAutoUnlockFromTrustedCache()
        await refreshCourseStatuses()
        if(user&&!derivedVaultKey)showPassphraseGate();
        if(currentCoursePath&&currentCourseData.course){showCourseContent(currentCourseData,currentCoursePath)}else if(user){setActiveSection("home")}
      })

    MicroModal.init()

    let allCourses=[]
    let currentCourseData={}
    let currentCoursePath=""
    const defaultGuidePath="lessons/0000_HowToUseThisSite.yaml"
    let isSidebarCollapsed=false
    let currentSection="home"
    let currentLessonSelection=null

    function setDerivedVaultKeyContext(key,saltBytes){derivedVaultKey=key;if(saltBytes)derivedVaultSalt=saltBytes}

    function bytesToBase64(bytes){const arr=bytes instanceof Uint8Array?bytes:new Uint8Array(bytes||[]);let bin="";arr.forEach(b=>bin+=String.fromCharCode(b));return btoa(bin)}
    function base64ToBytesLocal(str){if(!str)return new Uint8Array();const bin=atob(str);const out=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)out[i]=bin.charCodeAt(i);return out}

    function openTrustedDb(){return new Promise((resolve,reject)=>{const req=indexedDB.open(TRUSTED_WRAP_DB,1);req.onerror=()=>reject(req.error);req.onupgradeneeded=()=>{const db=req.result;if(!db.objectStoreNames.contains(TRUSTED_WRAP_STORE))db.createObjectStore(TRUSTED_WRAP_STORE)};req.onsuccess=()=>resolve(req.result)})}

    async function readStoreValue(key){const db=await openTrustedDb();return new Promise((resolve,reject)=>{const tx=db.transaction(TRUSTED_WRAP_STORE,"readonly");const store=tx.objectStore(TRUSTED_WRAP_STORE);const req=store.get(key);req.onsuccess=()=>resolve(req.result||null);req.onerror=()=>reject(req.error)})}

    async function writeStoreValue(key,value){const db=await openTrustedDb();return new Promise((resolve,reject)=>{const tx=db.transaction(TRUSTED_WRAP_STORE,"readwrite");tx.oncomplete=()=>resolve();tx.onerror=()=>reject(tx.error);tx.objectStore(TRUSTED_WRAP_STORE).put(value,key)})}

    async function deleteStoreValue(key){const db=await openTrustedDb();return new Promise((resolve,reject)=>{const tx=db.transaction(TRUSTED_WRAP_STORE,"readwrite");tx.oncomplete=()=>resolve();tx.onerror=()=>reject(tx.error);tx.objectStore(TRUSTED_WRAP_STORE).delete(key)})}

    async function getStoredWrappingKey(){try{return await readStoreValue(TRUSTED_WRAP_KEY_ID)}catch(err){console.error("Wrap key fetch failed",err);return null}}

    async function persistWrappingKey(key){try{await writeStoreValue(TRUSTED_WRAP_KEY_ID,key)}catch(err){console.error("Wrap key persist failed",err)}}

    async function clearTrustedDeviceCache(){try{localStorage.removeItem("trustedWrappedKey");localStorage.removeItem("trustedWrapSalt");localStorage.removeItem("trustedVaultSalt");await deleteStoreValue(TRUSTED_CACHE_ID);await deleteStoreValue(TRUSTED_WRAP_KEY_ID)}catch(err){console.error("Error clearing trusted cache",err)}}

    async function getOrCreateWrappingKey(){const existing=await getStoredWrappingKey();if(existing)return existing;const key=await crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["wrapKey","unwrapKey"]);await persistWrappingKey(key);return key}

    function cachePayloadLocally(wrappedBuffer,saltBytes,vaultSaltBytes){localStorage.setItem("trustedWrappedKey",bytesToBase64(new Uint8Array(wrappedBuffer||[])));localStorage.setItem("trustedWrapSalt",bytesToBase64(new Uint8Array(saltBytes||[])));if(vaultSaltBytes)localStorage.setItem("trustedVaultSalt",bytesToBase64(new Uint8Array(vaultSaltBytes)))}

    async function persistTrustedCache(keyToWrap,vaultSaltBytes){const wrappingKey=await getOrCreateWrappingKey();const saltBytes=crypto.getRandomValues(new Uint8Array(16));const iv=saltBytes.slice(0,12);const wrapped=await crypto.subtle.wrapKey("raw",keyToWrap,wrappingKey,{name:"AES-GCM",iv,additionalData:saltBytes});cachePayloadLocally(wrapped,saltBytes,vaultSaltBytes);await writeStoreValue(TRUSTED_CACHE_ID,{wrapped,saltBytes,vaultSaltBytes})}

    function readLocalCache(){const wrapped=localStorage.getItem("trustedWrappedKey");const salt=localStorage.getItem("trustedWrapSalt");const vaultSalt=localStorage.getItem("trustedVaultSalt");if(!wrapped||!salt)return null;return{wrapped:base64ToBytesLocal(wrapped),saltBytes:base64ToBytesLocal(salt),vaultSaltBytes:vaultSalt?base64ToBytesLocal(vaultSalt):null}}

    async function getTrustedCache(){const local=readLocalCache();if(local)return local;try{const stored=await readStoreValue(TRUSTED_CACHE_ID);if(stored)return{wrapped:new Uint8Array(stored.wrapped||[]),saltBytes:new Uint8Array(stored.saltBytes||[]),vaultSaltBytes:stored.vaultSaltBytes?new Uint8Array(stored.vaultSaltBytes):null}}catch(err){console.error("Trusted cache read failed",err)}return null}

    function getActiveSaltBytes(payload){if(payload&&payload.salt)return decodeSalt(payload.salt);if(derivedVaultSalt)return derivedVaultSalt;if(vaultDoc&&vaultDoc.salt)return decodeSalt(vaultDoc.salt);return null}

    function saltsMatch(a,b){if(!a||!b||a.length!==b.length)return false;for(let i=0;i<a.length;i++){if(a[i]!==b[i])return false}return true}

    function setSettingsStatus(message,type="info"){if(!settingsStatus)return;settingsStatus.textContent=message;settingsStatus.classList.remove("info","error","success");settingsStatus.classList.add(type)}

    function setQuizStatus(message,type="info"){if(!quizStatus)return;quizStatus.textContent=message;quizStatus.classList.remove("info","error","success");quizStatus.classList.add(type)}

    function setActiveSection(target){currentSection=target;Object.entries(sectionRegistry).forEach(([key,nodes])=>{nodes.forEach(node=>{node.classList.toggle("section-hidden",key!==target)})});Object.entries(navLinks).forEach(([key,link])=>{if(link)link.classList.toggle("active",key===target)});if(target==="notes")renderNotesSummary()}

    function updateQuizContext(customMessage){if(!quizLessonContext)return;if(customMessage){quizLessonContext.textContent=customMessage;return}if(currentLessonSelection&&currentLessonSelection.title){quizLessonContext.textContent=`Current lesson: ${currentLessonSelection.title}`}else if(currentCourseData?.course){quizLessonContext.textContent="Select a lesson in the Lessons page to target your quiz."}else{quizLessonContext.textContent="Choose a course from Home to begin."}}

    function showPassphraseGate(){if(gate){gate.style.display="flex"}}
    function hidePassphraseGate(){if(gate){gate.style.display="none"}}

    function buildVersionInfo(reason){return{version:DATA_MIGRATION_VERSION,updatedAt:new Date().toISOString(),reason}}

    function normalizeVersionInfo(info,reason){if(!info)return buildVersionInfo(reason);return{...info,version:info.version||DATA_MIGRATION_VERSION,updatedAt:new Date().toISOString(),reason:info.reason||reason}}

    function readPassphraseInput(){return(gatePassphraseInput?.value||vaultPassphraseInput?.value||"").trim()}

    function attachVersionMetadata(raw,reason){try{const parsed=JSON.parse(raw||"{}");const versionInfo=normalizeVersionInfo(parsed.versionInfo,reason);return JSON.stringify({...parsed,versionInfo})}catch(e){return JSON.stringify({value:raw||"",versionInfo:buildVersionInfo(reason)})}}

    function parseLessonProgressText(txt){try{const parsed=JSON.parse(txt||"{}");progressVersionInfo=normalizeVersionInfo(parsed.versionInfo,"lesson-progress-import");const lessons=parsed?.lessons||{};const notes=parsed?.notes||{};return{lessons,notes}}catch(e){progressVersionInfo=buildVersionInfo("lesson-progress-legacy");return{lessons:{},notes:{}}}}

    function serializeLessonProgress(){const normalized=normalizeVersionInfo(progressVersionInfo,"lesson-progress-save");progressVersionInfo=normalized;return JSON.stringify({lessons:lessonProgress.lessons||{},notes:lessonProgress.notes||{},versionInfo:normalized})}

    async function decryptLessonProgressPayload(payload,key){const decryptedText=await decryptSecret(payload,key);lessonProgress=parseLessonProgressText(decryptedText);encryptedLessonProgressPayload=payload;pendingEncryptedProgressPayload=null;await refreshCourseStatuses();renderNotesSummary();if(currentCoursePath&&currentCourseData.course){showCourseContent(currentCourseData,currentCoursePath)}}

    async function tryDecryptPendingProgress(){if(pendingEncryptedProgressPayload){try{const {key}=await ensureProgressKey(pendingEncryptedProgressPayload);await decryptLessonProgressPayload(pendingEncryptedProgressPayload,key)}catch(err){console.error("Error decrypting lesson progress:",err)}}}

    async function ensureProgressKey(payload){const saltBytes=getActiveSaltBytes(payload);if(derivedVaultKey&&derivedVaultSalt&&saltBytes&&saltsMatch(derivedVaultSalt,saltBytes)){setDerivedVaultKeyContext(derivedVaultKey,saltBytes);return{key:derivedVaultKey,saltBytes}}if(!saltBytes)throw new Error("Missing salt for encrypted progress.");throw new Error("Missing passphrase for encrypted progress.")}

    async function loadUserProgress(user){try{lessonProgress={lessons:{},notes:{}};encryptedLessonProgressPayload=null;pendingEncryptedProgressPayload=null;if(!user){renderNotesSummary();return}const snap=await getDoc(doc(db,"lessonProgress",user.uid));if(!snap.exists()){renderNotesSummary();return}const data=snap.data();if(data&&data.ciphertext){encryptedLessonProgressPayload=data;if(derivedVaultKey){const {key}=await ensureProgressKey(data);await decryptLessonProgressPayload(data,key)}else{pendingEncryptedProgressPayload=data}}else if(data&&(data.lessons||data.notes)){progressVersionInfo=normalizeVersionInfo(data.versionInfo,"lesson-progress-plaintext");lessonProgress={lessons:data.lessons||{},notes:data.notes||{}};renderNotesSummary()}}catch(e){console.error("Error loading progress:",e);lessonProgress={lessons:{},notes:{}};renderNotesSummary()}}
      async function persistUserProgress(){const user=auth.currentUser;if(!user)return false;if(!vaultDoc&&!encryptedLessonProgressPayload&&!derivedVaultKey){alert("Set up and unlock your vault before saving lesson progress.");return false}try{const {key,saltBytes}=await ensureProgressKey(encryptedLessonProgressPayload||vaultDoc);const encrypted=await encryptSecret(serializeLessonProgress(),key,saltBytes);await setDoc(doc(db,"lessonProgress",user.uid),encrypted);encryptedLessonProgressPayload=encrypted;pendingEncryptedProgressPayload=null;return true}catch(e){if(e&&e.message&&e.message.includes("Missing passphrase")){showPassphraseGate();alert("Unlock your vault with your master passphrase to sync progress.");return false}console.error("Error saving progress:",e);throw e}}
      function isLessonChecked(p,t){const lessons=lessonProgress?.lessons||{};return!!(lessons[p]&&lessons[p][t])}
      function toggleLessonChecked(p,t,v){if(!lessonProgress.lessons)lessonProgress.lessons={};if(!lessonProgress.lessons[p])lessonProgress.lessons[p]={};lessonProgress.lessons[p][t]=v}
      function getLessonNote(p,t){const notes=lessonProgress?.notes||{};return(notes[p]&&notes[p][t])||""}
      function setLessonNote(p,t,val){if(!lessonProgress.notes)lessonProgress.notes={};if(!lessonProgress.notes[p])lessonProgress.notes[p]={};lessonProgress.notes[p][t]=val}
      function getLessonIcon(t){if(t==="reading")return'<i class="fas fa-book"></i>';if(t==="quiz")return'<i class="fas fa-question-circle"></i>';if(t==="video")return'<i class="fas fa-video"></i>';return'<i class="fas fa-file-alt"></i>'}

      function renderNotesSummary(){if(!notesList||!notesEmptyState)return;notesList.innerHTML="";const canRead=!!derivedVaultKey;const entries=[];if(canRead){Object.entries(lessonProgress?.notes||{}).forEach(([path,lessonMap])=>{Object.entries(lessonMap||{}).forEach(([lessonTitle,text])=>{if(text&&text.trim()){entries.push({coursePath:path,lessonTitle,text:text.trim()})}})})}
        if(!canRead){notesEmptyState.textContent="Unlock with your master passphrase to view saved notes.";return}
        if(!entries.length){notesEmptyState.textContent="No saved notes yet. Open a lesson and add notes to see them here.";return}
        notesEmptyState.textContent="";entries.forEach(entry=>{const card=document.createElement("div");card.className="notes-card";const h=document.createElement("h4");h.textContent=entry.lessonTitle;const meta=document.createElement("p");meta.className="settings-note";meta.textContent=`Course file: ${entry.coursePath}`;const body=document.createElement("p");body.textContent=entry.text;card.appendChild(h);card.appendChild(meta);card.appendChild(body);notesList.appendChild(card)})}

      function clearVaultState(){derivedVaultKey=null;derivedVaultSalt=null;vaultDoc=null;decryptedUserPayload=null;encryptedLessonProgressPayload=null;pendingEncryptedProgressPayload=null;vaultPassphraseInput.value="";gatePassphraseInput.value="";setVaultUIState("locked");hidePassphraseGate();clearTrustedDeviceCache()}

      async function handleTrustedDeviceSelection(key,saltBytes){if(gateTrustedDevice?.checked){await persistTrustedCache(key,saltBytes)}else{await clearTrustedDeviceCache()}}

      async function tryAutoUnlockFromTrustedCache(){try{if(!vaultDoc)return false;const cache=await getTrustedCache();if(!cache)return false;const wrappingKey=await getStoredWrappingKey();if(!wrappingKey)return false;if(!cache.saltBytes||cache.saltBytes.length<12)return false;const iv=cache.saltBytes.slice(0,12);const unwrappedKey=await crypto.subtle.unwrapKey("raw",wrappingKey,cache.wrapped.buffer,{name:"AES-GCM",iv,additionalData:cache.saltBytes},{name:"AES-GCM",length:256},true,["encrypt","decrypt"]);const activeSalt=getActiveSaltBytes(vaultDoc)||cache.vaultSaltBytes;if(!activeSalt)throw new Error("Missing vault salt for cached key.");setDerivedVaultKeyContext(unwrappedKey,activeSalt);const decryptedText=await decryptSecret(vaultDoc,unwrappedKey);decryptedUserPayload=parseUserPayload(decryptedText);await tryDecryptPendingProgress();setVaultUIState("unlocked");if(gateTrustedDevice)gateTrustedDevice.checked=true;hidePassphraseGate();return true}catch(err){console.error("Trusted device auto-unlock failed",err);await clearTrustedDeviceCache();return false}}

      function getDefaultUserPayload(){const normalized=normalizeVersionInfo(profileVersionInfo,"profile-default");profileVersionInfo=normalized;return{secret:"",displayName:"",apiKey:"",metadata:"",versionInfo:normalized}}

      function parseUserPayload(text){try{const parsed=JSON.parse(text);profileVersionInfo=normalizeVersionInfo(parsed.versionInfo,"profile-import");return{...getDefaultUserPayload(),...parsed,versionInfo:profileVersionInfo}}catch(e){const fallback=buildVersionInfo("profile-legacy");profileVersionInfo=fallback;return{...getDefaultUserPayload(),secret:text||"",versionInfo:fallback}}}

      function serializeUserPayload(){const payload={...getDefaultUserPayload(),...(decryptedUserPayload||{})};const normalized=normalizeVersionInfo(payload.versionInfo,"profile-save");profileVersionInfo=normalized;payload.versionInfo=normalized;return JSON.stringify(payload)}

      async function persistEncryptedPayload(key,saltBytes){const user=auth.currentUser;if(!user)return;setDerivedVaultKeyContext(key,saltBytes);const encrypted=await encryptSecret(serializeUserPayload(),key,saltBytes);await setDoc(doc(db,"userData",user.uid),encrypted);vaultDoc=encrypted}

      async function logMigrationMetadata(user,details){try{await setDoc(doc(db,"userMetadata",user.uid),{...details,version:DATA_MIGRATION_VERSION,updatedAt:new Date().toISOString()},{merge:true})}catch(err){console.error("Metadata log failed",err)}}

      function setVaultUIState(mode){if(!vaultContainer)return;const hasUser=!!auth.currentUser;const shouldShowCard=hasUser&&mode!=="unlocked";vaultContainer.style.display=shouldShowCard?"block":"none";if(mode==="setup"){vaultHeading.textContent="Secure your account";vaultDescription.textContent="Create a master passphrase to unlock lessons, settings, and notes.";initializeVaultBtn.style.display="inline-block";unlockVaultBtn.style.display="none"}else if(mode==="locked"){vaultHeading.textContent="Unlock your vault";vaultDescription.textContent="Enter your master passphrase to continue.";initializeVaultBtn.style.display="none";unlockVaultBtn.style.display="inline-block"}else{vaultHeading.textContent="Vault unlocked";vaultDescription.textContent="Your session key is active. You can rotate the passphrase in Settings.";initializeVaultBtn.style.display="none";unlockVaultBtn.style.display="none"}}

      async function loadVaultState(user){try{if(!user){clearVaultState();return}const snap=await getDoc(doc(db,"userData",user.uid));if(snap.exists()){vaultDoc=snap.data();setVaultUIState("locked")}else{vaultDoc=null;setVaultUIState("setup")}}catch(e){console.error("Error loading vault:",e);setVaultUIState("setup")}}

      async function initializeVault(){try{const user=auth.currentUser;if(!user)return;const passphrase=readPassphraseInput();if(passphrase.length<12){alert("Please choose a longer passphrase (at least 12 characters).");return}const {key,salt}=await deriveKeyFromPassphrase(passphrase);setDerivedVaultKeyContext(key,salt);decryptedUserPayload={...getDefaultUserPayload()};await persistEncryptedPayload(key,salt);await handleTrustedDeviceSelection(key,salt);await tryDecryptPendingProgress();setVaultUIState("unlocked");hidePassphraseGate();alert("Vault initialized. Remember to store your passphrase safely—there is no recovery option.")}catch(err){console.error("Error initializing vault",err);alert("Could not initialize vault. Please try again.")}}

      async function loadEncryptedProfile(passphrase){if(!vaultDoc){throw new Error("No encrypted profile available.")}const saltBytes=vaultDoc?.salt?decodeSalt(vaultDoc.salt):null;if(!saltBytes)throw new Error("Missing vault salt. Reinitialize the vault.");const {key}=await deriveKeyFromPassphrase(passphrase,saltBytes);const decryptedText=await decryptSecret(vaultDoc,key);setDerivedVaultKeyContext(key,saltBytes);decryptedUserPayload=parseUserPayload(decryptedText);await tryDecryptPendingProgress();hidePassphraseGate();return{key,saltBytes}}

      async function unlockVault(){try{if(!vaultDoc){alert("No vault found to unlock.");return}const passphrase=readPassphraseInput();if(!passphrase){alert("Enter your master passphrase to unlock.");return}const {key,saltBytes}=await loadEncryptedProfile(passphrase);await handleTrustedDeviceSelection(key,saltBytes);setVaultUIState("unlocked");hidePassphraseGate()}catch(err){console.error("Unlock failed",err);alert("Could not unlock vault. Double-check your passphrase.")}}

      function resetSettingsForm(){settingsNewPassphrase.value="";settingsDisplayName.value="";settingsApiKey.value="";settingsMetadata.value="";settingsFields.style.display="none";setSettingsStatus("", "info")}

      function populateSettingsFields(){const payload=decryptedUserPayload||getDefaultUserPayload();settingsDisplayName.value=payload.displayName||"";settingsApiKey.value=payload.apiKey||"";settingsMetadata.value=payload.metadata||"";settingsFields.style.display="block"}


      async function saveSettings(){try{if(!vaultDoc){alert("Initialize your encrypted profile first.");return}if(!derivedVaultKey){showPassphraseGate();alert("Unlock with your passphrase before saving settings.");return}const saltBytes=getActiveSaltBytes(vaultDoc);if(!saltBytes){alert("Missing vault salt. Reinitialize the vault.");return}setSettingsStatus("Saving settings...","info");decryptedUserPayload={...getDefaultUserPayload(),...(decryptedUserPayload||{}),displayName:settingsDisplayName.value.trim(),apiKey:settingsApiKey.value.trim(),metadata:settingsMetadata.value.trim()};await persistEncryptedPayload(derivedVaultKey,saltBytes);settingsFields.style.display="block";setSettingsStatus("Settings saved with updated encryption.","success");alert("Settings saved. Keep your passphrase safe.")}catch(err){console.error("Settings save failed",err);setSettingsStatus("Could not save settings. Unlock with your passphrase and try again.","error");alert("Could not save settings. Please try again.")}}

      async function reencryptQuizDocs(oldKey,newKey,newSalt,missingCollections){const user=auth.currentUser;if(!user)return null;const quizRef=doc(db,"quizzes",user.uid);const snap=await getDoc(quizRef);if(!snap.exists()){missingCollections.push("quizzes");return null}const data=snap.data();if(!data.ciphertext){missingCollections.push("quizzes-unencrypted");return null}const decrypted=await decryptSecret(data,oldKey);const serialized=attachVersionMetadata(decrypted,"quizzes-reencrypt");const encrypted=await encryptSecret(serialized,newKey,newSalt);await setDoc(quizRef,encrypted);return encrypted}

      async function rotatePassphrase(){try{if(!vaultDoc){alert("Nothing to rotate yet. Initialize your vault first.");return}const user=auth.currentUser;if(!user)return;if(!derivedVaultKey){showPassphraseGate();alert("Unlock with your passphrase to rotate it.");return}const newPass=settingsNewPassphrase.value.trim();if(newPass.length<12){alert("Choose a stronger new passphrase (at least 12 characters).");return}setSettingsStatus("Deriving new encryption key...","info");const {key:newKey,salt:newSalt}=await deriveKeyFromPassphrase(newPass);setSettingsStatus("Re-encrypting profile and progress...","info");const updatedVaultPayload=await encryptSecret(serializeUserPayload(),newKey,newSalt);const updatedProgressPayload=await encryptSecret(serializeLessonProgress(),newKey,newSalt);const missingCollections=[];let updatedQuizPayload=null;try{updatedQuizPayload=await reencryptQuizDocs(derivedVaultKey,newKey,newSalt,missingCollections);if(updatedQuizPayload)setSettingsStatus("Re-encrypted quiz history.","info")}catch(err){console.error("Quiz re-encryption failed",err);missingCollections.push("quizzes-error");setSettingsStatus("Quiz data could not be re-encrypted.","error")}setSettingsStatus("Committing rotated keys...","info");await runTransaction(db,async tx=>{tx.set(doc(db,"userData",user.uid),updatedVaultPayload);tx.set(doc(db,"lessonProgress",user.uid),updatedProgressPayload);if(updatedQuizPayload)tx.set(doc(db,"quizzes",user.uid),updatedQuizPayload)});setDerivedVaultKeyContext(newKey,newSalt);vaultDoc=updatedVaultPayload;encryptedLessonProgressPayload=updatedProgressPayload;pendingEncryptedProgressPayload=null;settingsNewPassphrase.value="";vaultPassphraseInput.value="";await logMigrationMetadata(user,{lastRotationAt:new Date().toISOString(),missingCollections});const statusNote=missingCollections.length?`Rotation complete. Missing collections: ${missingCollections.join(", ")}`:"Passphrase rotated and data re-encrypted.";setSettingsStatus(statusNote,missingCollections.length?"info":"success");alert("Passphrase rotated. You must remember the new passphrase to keep access.");setVaultUIState("locked");showPassphraseGate()}catch(err){console.error("Passphrase rotation failed",err);setSettingsStatus("Could not rotate passphrase. No changes were applied.","error");alert("Could not rotate passphrase. Confirm your passphrase and try again. If the old passphrase was incorrect, no data was changed.")}}

      async function resetEncryptedAccount(){try{if(!vaultDoc){alert("No encrypted data to reset.");return}const confirmed=confirm("This will delete your encrypted data and progress. Continue?");if(!confirmed)return;const user=auth.currentUser;if(!user)return;const missingCollections=[];setSettingsStatus("Deleting encrypted documents...","info");await deleteDoc(doc(db,"userData",user.uid));await deleteDoc(doc(db,"lessonProgress",user.uid));try{await deleteDoc(doc(db,"quizzes",user.uid))}catch(err){console.error("Quiz deletion failed",err);missingCollections.push("quizzes-error")}await deleteDoc(doc(db,"userMetadata",user.uid));clearVaultState();lessonProgress={lessons:{},notes:{}};profileVersionInfo=buildVersionInfo("profile-reset");progressVersionInfo=buildVersionInfo("lesson-progress-reset");setVaultUIState("setup");await logMigrationMetadata(user,{lastResetAt:new Date().toISOString(),missingCollections});MicroModal.close("modal-settings");setSettingsStatus("Encrypted data cleared. Defaults restored.","success");showPassphraseGate();alert("Encrypted profile reset. Set up a new passphrase to start again.")}catch(err){console.error("Reset failed",err);setSettingsStatus("Could not reset encrypted data.","error");alert("Could not reset encrypted data. Try again.")}}

    async function loadCourses(){try{const r=await fetch("lessons.json");if(!r.ok)throw new Error("Could not load lessons.json");return await r.json()}catch(e){console.error("Error fetching lessons.json:",e);return[]}}

    async function updateAllCourseStatuses(cs){const tasks=cs.map(async c=>{try{const resp=await fetch(c.file);if(!resp.ok)throw new Error("Could not load "+c.file);const yText=await resp.text();const data=jsyaml.load(yText);if(data&&data.course&&Array.isArray(data.course.lessons)){const total=data.course.lessons.length;const completed=data.course.lessons.filter(l=>{const lbl=l.title||"Lesson "+l.lesson_id;return isLessonChecked(c.file,lbl)}).length;c._status=computeCourseStatus(completed,total)}else c._status="N/A"}catch(err){console.error("Error fetching YAML for",c.file,err);c._status="N/A"}});await Promise.all(tasks)}

    async function refreshCourseStatuses(){await updateAllCourseStatuses(allCourses);renderCourses(allCourses)}

    function computeCourseStatus(cmp,tot){if(tot===0)return"N/A";if(cmp===0)return"Not Started";if(cmp===tot)return"Complete";return"In Progress"}

    function renderCourses(cs){const cl=document.getElementById("courseList");cl.innerHTML="";cs.forEach(cr=>{const d=document.createElement("div");d.classList.add("course-card");let st="n-a";if(cr._status)st=cr._status.toLowerCase().replace(/\s+/g,"-");d.innerHTML="<h3>"+cr.title+"</h3><p>Course ID: "+cr.id+"</p><p class='course-status "+st+"'>"+(cr._status||"N/A")+"</p><button data-file='"+cr.file+"'>View Lessons</button>";cl.appendChild(d)})}

    function filterCourses(cs,q){return cs.filter(c=>c.title.toLowerCase().includes(q.toLowerCase()))}

    async function handleViewLessons(p){try{if(!auth.currentUser){MicroModal.show("modal-locked");return}if(!derivedVaultKey){showPassphraseGate();alert("Unlock with your passphrase to view lessons.");return}const resp=await fetch(p);if(!resp.ok)throw new Error("Unable to load YAML file: "+p);const y=await resp.text();const cd=jsyaml.load(y);currentCourseData=cd;currentCoursePath=p;currentLessonSelection=null;setActiveSection("lessons");updateQuizContext();showCourseContent(cd,p)}catch(e){console.error("Error fetching YAML:",e)}}

    function showCourseContent(cd,fp){if(!cd||!cd.course)return;setActiveSection("lessons");updateQuizContext();setQuizStatus("");const cObj=cd.course;const container=document.getElementById("lessonsContainer");const cTitle=document.getElementById("selectedCourseTitle");const cDesc=document.getElementById("selectedCourseDesc");const lList=document.getElementById("lessonList");const lContent=document.getElementById("lessonContent");const lProgress=document.getElementById("lessonProgress");container.style.display="block";cTitle.textContent=cObj.title||"Untitled Course";cDesc.textContent=cObj.description||"";lList.innerHTML="";lContent.innerHTML="<p style='color:#999;'>Select a lesson on the left to see details here.</p>";(cObj.lessons||[]).forEach(lesson=>{const lbl=lesson.title||"Lesson "+lesson.lesson_id;if(lesson.section&&!document.getElementById("section-"+lesson.section)){const s=document.createElement("h4");s.id="section-"+lesson.section;s.classList.add("title-text");s.textContent=lesson.section;lList.appendChild(s)}const li=document.createElement("li");if(isLessonChecked(fp,lbl))li.classList.add("completed");const icon=lesson.type?getLessonIcon(lesson.type):'<i class="fas fa-file-alt"></i>';li.innerHTML="<div class='icon-area'>"+icon+"</div><div class='lesson-title'>"+lbl+"</div><div class='hover-checkbox'><input type='checkbox'"+(isLessonChecked(fp,lbl)?" checked":"")+" /></div>";li.addEventListener("click",e=>{if(!e.target.closest(".hover-checkbox")){if(!auth.currentUser&&fp!==defaultGuidePath&&lbl!=="Getting Started"){MicroModal.show("modal-locked");return}document.querySelectorAll("#lessonList li").forEach(n=>n.classList.remove("active"));li.classList.add("active");displayLessonContent(lesson)}});const cb=li.querySelector(".hover-checkbox input[type='checkbox']");cb.addEventListener("change",async()=>{const desiredState=cb.checked;toggleLessonChecked(fp,lbl,desiredState);li.classList.toggle("completed",desiredState);updateProgress(fp);try{const saved=await persistUserProgress();if(saved===false){cb.checked=!desiredState;toggleLessonChecked(fp,lbl,cb.checked);li.classList.toggle("completed",cb.checked);updateProgress(fp);return}}catch(err){console.error("Progress save failed",err);cb.checked=!desiredState;toggleLessonChecked(fp,lbl,cb.checked);li.classList.toggle("completed",cb.checked);updateProgress(fp);const retry=confirm("Could not save progress. Re-enter your passphrase to retry?");if(retry){try{await persistUserProgress()}catch(err2){console.error("Retry failed",err2);alert("Progress not synced. Unlock with your passphrase and try again.")}}}});if(!auth.currentUser&&fp!==defaultGuidePath&&lbl!=="Getting Started")li.classList.add("locked");lList.appendChild(li)});function updateProgress(path){const tot=(cObj.lessons||[]).length;const comp=(cObj.lessons||[]).filter(ls=>isLessonChecked(path,ls.title||"Lesson "+ls.lesson_id)).length;lProgress.textContent="Completed "+comp+" / "+tot+" lessons";let status="";if(comp===0)status="(not-started)";else if(comp===tot)status="(complete)";else status="(in-progress)";cTitle.textContent=(cObj.title||"Untitled Course")+" "+status;updateCourseCardStatus(path)}updateProgress(fp)}

    function displayLessonContent(lsn){const el=document.getElementById("lessonContent");el.innerHTML="";const title=lsn.title||"Lesson "+lsn.lesson_id;currentLessonSelection={title,coursePath:currentCoursePath,lesson:lsn};updateQuizContext();setQuizStatus("");const h=document.createElement("h1");h.textContent=title;el.appendChild(h);const hr=document.createElement("hr");el.appendChild(hr);if(lsn.course){const n=document.createElement("div");n.innerHTML=marked.parse(lsn.course);el.appendChild(n)}if(lsn.exercises&&Array.isArray(lsn.exercises)&&lsn.exercises.length){const exH=document.createElement("h2");exH.textContent="Exercises:";el.appendChild(exH);let m="\n";lsn.exercises.forEach((ex,i)=>{m+=(i+1)+". **"+ex.name+"** – "+ex.prompt+"\n"});const d=document.createElement("div");d.innerHTML=marked.parse(m);el.appendChild(d)}if(lsn.assignments&&Array.isArray(lsn.assignments)&&lsn.assignments.length){const asH=document.createElement("h2");asH.textContent="Assignments:";el.appendChild(asH);let m="\n";lsn.assignments.forEach((a,i)=>{m+=(i+1)+". **"+a.name+"** – "+a.description+"\n"});const d=document.createElement("div");d.innerHTML=marked.parse(m);el.appendChild(d)}if(lsn.sources&&Array.isArray(lsn.sources)&&lsn.sources.length){const srcH=document.createElement("h2");srcH.textContent="Sources:";el.appendChild(srcH);let m="\n";lsn.sources.forEach((s,i)=>{m+=(i+1)+". "+s+"\n"});const d=document.createElement("div");d.innerHTML=marked.parse(m);el.appendChild(d)}const notesWrapper=document.createElement("div");notesWrapper.className="lesson-notes";const notesHeading=document.createElement("h3");notesHeading.textContent="Your notes";const noteHint=document.createElement("p");noteHint.className="settings-note";noteHint.textContent="Notes are encrypted with your passphrase and saved per lesson.";const noteField=document.createElement("textarea");noteField.value=getLessonNote(currentCoursePath,title);noteField.placeholder="Add private notes for this lesson.";const noteActions=document.createElement("div");noteActions.className="note-actions";const saveNoteBtn=document.createElement("button");saveNoteBtn.textContent="Save notes";saveNoteBtn.addEventListener("click",async()=>{if(!auth.currentUser){alert("Sign in before saving notes.");return}if(!derivedVaultKey){showPassphraseGate();alert("Unlock with your passphrase before saving notes.");return}setLessonNote(currentCoursePath,title,noteField.value);try{await persistUserProgress();renderNotesSummary();saveNoteBtn.textContent="Saved";setTimeout(()=>saveNoteBtn.textContent="Save notes",1500)}catch(err){console.error("Note save failed",err);alert("Could not save notes. Unlock with your passphrase and try again.")}});noteActions.appendChild(saveNoteBtn);notesWrapper.appendChild(notesHeading);notesWrapper.appendChild(noteHint);notesWrapper.appendChild(noteField);notesWrapper.appendChild(noteActions);el.appendChild(notesWrapper)}

      async function startQuizGeneration(){if(!quizStatus)return;if(!auth.currentUser){MicroModal.show("modal-locked");setQuizStatus("Sign in to generate quizzes.","error");return}if(!derivedVaultKey){showPassphraseGate();setQuizStatus("Unlock with your passphrase to generate quizzes.","error");return}if(!currentLessonSelection){setQuizStatus("Open a lesson in the Lessons page before generating a quiz.","error");return}setQuizStatus(`Starting quiz generation for ${currentLessonSelection.title}...`,`info`);try{setQuizStatus(`Quiz generation started for ${currentLessonSelection.title}. Keep this page open.`,`success`)}catch(err){console.error("Quiz generation failed",err);setQuizStatus("Could not start quiz generation. Try again after unlocking your vault.","error")}}

      function updateCourseCardStatus(p){const co=allCourses.find(c=>c.file===p);if(!co||!currentCourseData.course)return;const tot=(currentCourseData.course.lessons||[]).length;const comp=(currentCourseData.course.lessons||[]).filter(l=>isLessonChecked(p,l.title||"Lesson "+l.lesson_id)).length;co._status=computeCourseStatus(comp,tot);const card=document.querySelector(".course-card button[data-file='"+p+"']")?.closest(".course-card");if(card){const st=card.querySelector(".course-status");if(st){st.classList.remove("not-started","in-progress","complete","n-a");st.textContent=co._status;const cls=co._status.toLowerCase().replace(/\s+/g,"-");st.classList.add(cls)}}}

      function toggleSidebar(){const sb=document.getElementById("lessonSidebar");const lo=document.getElementById("lessonLayout");isSidebarCollapsed=!isSidebarCollapsed;if(isSidebarCollapsed){sb.classList.add("collapsed");lo.classList.add("collapsed")}else{sb.classList.remove("collapsed");lo.classList.remove("collapsed")}}

      if(vaultContainer){setVaultUIState("setup")}
      generatePassphraseBtn?.addEventListener("click",()=>{const newPass=generatePassphrase();vaultPassphraseInput.value=newPass;alert("Passphrase generated. Copy it and store it somewhere safe—there is no recovery option.")})
      copyPassphraseBtn?.addEventListener("click",async()=>{const val=vaultPassphraseInput.value;if(!val){alert("Nothing to copy yet. Enter or generate a passphrase first.");return}try{await navigator.clipboard.writeText(val);alert("Passphrase copied. Store it safely before continuing.")}catch(err){console.error("Clipboard error",err);alert("Could not copy automatically. Please copy the passphrase manually.")}})
      initializeVaultBtn?.addEventListener("click",initializeVault)
      unlockVaultBtn?.addEventListener("click",unlockVault)
      gateUnlockBtn?.addEventListener("click",unlockVault)
      gateInitializeBtn?.addEventListener("click",initializeVault)
      gateGenerateBtn?.addEventListener("click",()=>{const generated=generatePassphrase();gatePassphraseInput.value=generated;vaultPassphraseInput.value=generated;alert("Passphrase generated. Copy it and store it somewhere safe.")})
      openSettingsBtn?.addEventListener("click",()=>{resetSettingsForm();if(!derivedVaultKey){settingsFields.style.display="none";setSettingsStatus("Unlock with your passphrase to edit settings. You can still reset your account below.","info");MicroModal.show("modal-settings");showPassphraseGate();return}populateSettingsFields();setSettingsStatus("Settings unlocked for this session.","success");MicroModal.show("modal-settings")})
      signOutBtn?.addEventListener("click",async()=>{await signOut(auth)})
      saveSettingsBtn?.addEventListener("click",saveSettings)
      rotatePassphraseBtn?.addEventListener("click",rotatePassphrase)
      resetAccountBtn?.addEventListener("click",resetEncryptedAccount)

      document.addEventListener("DOMContentLoaded",async()=>{allCourses=await loadCourses();await refreshCourseStatuses();setActiveSection("home");updateQuizContext();renderNotesSummary();document.getElementById("courseSearch")?.addEventListener("input",e=>{renderCourses(filterCourses(allCourses,e.target.value))});document.addEventListener("click",e=>{const b=e.target;if(b.tagName==="BUTTON"&&b.hasAttribute("data-file"))handleViewLessons(b.getAttribute("data-file"))});Object.entries(navLinks).forEach(([section,link])=>{if(!link)return;link.addEventListener("click",e=>{e.preventDefault();if(section==="lessons"&&!currentCoursePath){setActiveSection("lessons");updateQuizContext("Select a course from Home to view lessons.");return}setActiveSection(section);if(section==="quizzes")updateQuizContext()})});document.getElementById("sidebarToggle").addEventListener("click",toggleSidebar);generateQuizBtn?.addEventListener("click",startQuizGeneration)})
  </script>
</body>
</html>
